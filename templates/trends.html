<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Tracker - Trends</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">Mental Health Tracker</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Daily Log</a>
                <a class="nav-link active" href="/trends">Trends</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">Your Mental Health Trends</h1>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Mental Health Metrics Over Time</h3>
                <p class="text-muted">Track how your feelings change over time</p>
            </div>
            <div class="card-body">
                <div id="metricsChart" style="height: 400px;"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Activity Impact Analysis</h3>
                <p class="text-muted">See how different activities affect your mental health</p>
            </div>
            <div class="card-body">
                <div id="activityImpactChart" style="height: 400px;"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Weekly Activity Summary</h3>
                <p class="text-muted">Track your consistency with positive activities</p>
            </div>
            <div class="card-body">
                <div id="weeklyActivityChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fetch and display trends
        async function fetchAndDisplayTrends() {
            const response = await fetch('/get_logs');
            const data = await response.json();

            if (data.length === 0) {
                document.querySelectorAll('.card-body').forEach(el => {
                    el.innerHTML = '<p class="text-center text-muted">No data available yet. Start logging your daily mental health to see trends!</p>';
                });
                return;
            }

            // Mental Health Metrics Over Time
            const metrics = [
                {name: 'Overall Feeling', key: 'overall_feeling', color: '#4299e1'},
                {name: 'Self Confidence', key: 'self_confidence', color: '#48bb78'},
                {name: 'Self Worth', key: 'self_worth', color: '#ed8936'},
                {name: 'Energy Levels', key: 'energy_levels', color: '#9f7aea'},
                {name: 'Physical Wellness', key: 'physical_wellness', color: '#f56565'}
            ];

            const metricTraces = metrics.map(metric => ({
                x: data.map(d => d.date),
                y: data.map(d => d[metric.key]),
                type: 'scatter',
                mode: 'lines+markers',
                name: metric.name,
                line: {color: metric.color}
            }));

            Plotly.newPlot('metricsChart', metricTraces, {
                margin: {t: 20},
                xaxis: {title: 'Date'},
                yaxis: {title: 'Score', range: [0, 10]},
                showlegend: true,
                legend: {orientation: 'h', y: -0.2}
            });

            // Activity Impact Analysis
            const activities = [
                'slept_well', 'ate_well', 'cold_water', 'meditated', 'breathwork',
                'exercised', 'hydrated', 'bgl_control', 'displayed_courage', 'comfort_zone'
            ];

            const activityLabels = {
                'slept_well': 'Sleep',
                'ate_well': 'Nutrition',
                'cold_water': 'Cold Water',
                'meditated': 'Meditation',
                'breathwork': 'Breathwork',
                'exercised': 'Exercise',
                'hydrated': 'Hydration',
                'bgl_control': 'BGL Control',
                'displayed_courage': 'Courage',
                'comfort_zone': 'Comfort Zone'
            };

            const activityImpact = activities.map(activity => {
                const daysWithActivity = data.filter(d => d[activity]);
                const daysWithoutActivity = data.filter(d => !d[activity]);

                const avgWithActivity = metrics.map(metric => ({
                    metric: metric.name,
                    value: daysWithActivity.length > 0 
                        ? daysWithActivity.reduce((sum, d) => sum + d[metric.key], 0) / daysWithActivity.length 
                        : 0
                }));

                const avgWithoutActivity = metrics.map(metric => ({
                    metric: metric.name,
                    value: daysWithoutActivity.length > 0 
                        ? daysWithoutActivity.reduce((sum, d) => sum + d[metric.key], 0) / daysWithoutActivity.length 
                        : 0
                }));

                return {
                    activity: activityLabels[activity],
                    withActivity: avgWithActivity,
                    withoutActivity: avgWithoutActivity
                };
            });

            const impactTraces = [];
            metrics.forEach((metric, i) => {
                impactTraces.push({
                    x: activityImpact.map(d => d.activity),
                    y: activityImpact.map(d => d.withActivity[i].value),
                    type: 'bar',
                    name: `${metric.name} (with activity)`,
                    marker: {color: metric.color}
                });
                impactTraces.push({
                    x: activityImpact.map(d => d.activity),
                    y: activityImpact.map(d => d.withoutActivity[i].value),
                    type: 'bar',
                    name: `${metric.name} (without activity)`,
                    marker: {color: metric.color, opacity: 0.5}
                });
            });

            Plotly.newPlot('activityImpactChart', impactTraces, {
                margin: {t: 20, b: 120},
                barmode: 'group',
                xaxis: {title: 'Activity', tickangle: 45},
                yaxis: {title: 'Average Score', range: [0, 10]},
                showlegend: true,
                legend: {orientation: 'h', y: -0.5}
            });

            // Weekly Activity Summary
            const last7Days = data.slice(-7);
            const weeklyActivityData = activities.map(activity => ({
                x: last7Days.map(d => d.date),
                y: last7Days.map(d => d[activity] ? 1 : 0),
                type: 'scatter',
                mode: 'lines+markers',
                name: activityLabels[activity],
                line: {shape: 'hv'}
            }));

            Plotly.newPlot('weeklyActivityChart', weeklyActivityData, {
                margin: {t: 20},
                xaxis: {title: 'Date'},
                yaxis: {
                    title: 'Completed',
                    range: [-0.1, 1.1],
                    ticktext: ['No', 'Yes'],
                    tickvals: [0, 1]
                },
                showlegend: true,
                legend: {orientation: 'h', y: -0.2}
            });
        }

        // Load trends when the page loads
        fetchAndDisplayTrends();
    </script>
</body>
</html> 